{{define "content"}}
    <form id="loginUserForm" method="POST">
        <div class="form-group">
            <label for="userEmail">Email address</label>
            <input type="email" class="form-control" name="userEmail" id="userEmail" aria-describedby="emailHelp" required>
        </div>
        <div class="form-group">
            <label for="userPwd">Password</label>
            <input type="password" class="form-control" name="userPwd" id="userPwd" minlength="8" required>
        </div>
        {{ .CsrfTag }}
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
{{end}}

{{define "script"}}
    <script>
        function postIdTokenToSessionLogin(url, idToken) {
            url = "http://127.0.0.1:8000" + url;
            $.ajax({
                url: url,
                type: 'POST',
                headers: {
                    "X-CSRF-Token": document.getElementsByName("gorilla.csrf.Token")[0].value
                },
                credentials: true,
                data: {
                    idToken: idToken
                },
                success: function(response) {
                },
                error: function(xhr) {
                    console.log(arguments);
                }
            });
        }

        $( "#loginUserForm" ).submit(function( event ) {
            event.preventDefault();
            const user_email = $('#userEmail').val();
            const user_pwd = $('#userPwd').val();
            // As httpOnly cookies are to be used, do not persist any state client side.
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);

            // When the user signs in with email and password.
            firebase.auth().signInWithEmailAndPassword(user_email, user_pwd).then(user => {
                // Get the user's ID token as it is needed to exchange for a session cookie.
                return firebase.auth().currentUser.getIdToken().then(idToken => {
                    // Session login endpoint is queried and the session cookie is set.
                    // CSRF protection should be taken into account.
                    // ...
                    // alert(idToken);
                    // const csrfToken = getCookie('csrfToken');
                    return postIdTokenToSessionLogin('/sessionLogin/', idToken);
            });
            }).then(() => {
                // A page redirect would suffice as the persistence is set to NONE.
                return firebase.auth().signOut();
            }).then(() => {
                window.location.assign('/');
            });
        });
    </script>
{{end}}